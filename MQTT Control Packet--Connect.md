# MQTT报文--连接，连接确认以及断开连接报文

因为最近在忙些别的事情，博客有段时间没有更新了，但是作为一个物联网软件工程师，一直坚信MQTT是个好东西，他简单高效，提供了许多实用的特性，对它是十分的喜欢呀~~~

今天我们来讲连接报文，连接报文是非常重要的报文，它提供的许多特性可以应用到很多场景中，现在就让我们就脱掉裤子，哦不对，撸起袖子加油干吧。

### CONNECT Packet

MQTT客户端是通过TCP/IP协议与Broker建立连接的，连接建立之后，Client发送的第一条数据报文就是CONNECT Packet。我们之前说过MQTT的报文协议，分别包含固定头，可变头以及消息内容。下面分别介绍：

#### Fixed Header

| Bit       | 7    | 6    | 5    | 4         | 3      | 2    | 1    | 0    |
| --------- | ---- | ---- | ---- | --------- | ------ | ---- | ---- | ---- |
| Byte 1    | 0    | 0    | 0    | 1         | 0      | 0    | 0    | 0    |
| Byte 2... |      |      |      | Remaining | Length |      |      |      |
|           |      |      |      |           |        |      |      |      |

复习一下固定头的格式，固定头长度为2~5字节，第一字节为控制字节。控制字节高4位(Bit7~Bit4)用于表示协议类型，值1表示CONNECT Packet。在连接报文中，低4位(Bit3~Bit0)是保留字段，必须都为0。

固定头从第二字节开始，用于表示剩余消息长度，剩余消息长度=可变头长度+消息内容长度。



#### Variable Header

可变头包含协议名称，协议等级，连接标记，以及Keep Alive时间。

##### 协议名称

连接报文中，从Byte1~Byte6表示协议名称，其中前两位Byte1~Byte2表示协议名称的长度，后4位Byte3~Byte6是MQTT的UTF8编码。协议名称是固定的，即使在将来的版本中也不会变化。

| Byte1 | Byte2 | Byte3 | Byte4 | Byte5 | Byte6 | Byte7 |
| ----- | ----- | ----- | ----- | ----- | ----- | ----- |
| 0     | 4     | M     | Q     | T     | T     | 4     |

有些抓包软件如Wireshark，可以利用协议名称来判断一个数据包是不是MQTT数据包。

##### 协议等级

连接报文的第8字节Byte7(编号从Byte0开始)表示协议等级，当前的协议版本是3.3.1，其协议等级是4.

##### 连接标记

连接报文的第9字节Byte8是连接标记。一个字节共有8位，除了Bit0是保留位以外，其它每1位(或2位)都用来表示一个连接标记。如下表：

| Bit  | 7    | 6    | 5    | 4    | 3    | 2    | 1    | 0    |
| ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- | ---- |
|      |      |      |      |      |      |      |      |      |
|      |      |      |      |      |      |      |      |      |



#### Payload











### CONNACK Packet



